<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Benjamin Doran">
<meta name="dcterms.date" content="2024-12-08">

<title>Benjamin Doran – Setting up a reproducible multi-language data analysis environment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../_data/images/distortions.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../_data/images/distortions.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Benjamin Doran</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">About me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#surrounding-tools" id="toc-surrounding-tools" class="nav-link" data-scroll-target="#surrounding-tools">Surrounding tools</a></li>
  <li><a href="#installing-julia" id="toc-installing-julia" class="nav-link" data-scroll-target="#installing-julia">Installing Julia</a></li>
  <li><a href="#julia-specific-setup" id="toc-julia-specific-setup" class="nav-link" data-scroll-target="#julia-specific-setup">Julia specific setup</a></li>
  <li><a href="#project-specific-setup" id="toc-project-specific-setup" class="nav-link" data-scroll-target="#project-specific-setup">Project specific setup</a></li>
  <li><a href="#layout-of-project" id="toc-layout-of-project" class="nav-link" data-scroll-target="#layout-of-project">Layout of project</a>
  <ul class="collapse">
  <li><a href="#main-important-folders" id="toc-main-important-folders" class="nav-link" data-scroll-target="#main-important-folders">main important folders</a></li>
  <li><a href="#other-folders" id="toc-other-folders" class="nav-link" data-scroll-target="#other-folders">other folders</a></li>
  <li><a href="#additional-folder-that-i-create" id="toc-additional-folder-that-i-create" class="nav-link" data-scroll-target="#additional-folder-that-i-create">additional folder that I create</a></li>
  </ul></li>
  <li><a href="#starting-the-project" id="toc-starting-the-project" class="nav-link" data-scroll-target="#starting-the-project">Starting the project</a></li>
  <li><a href="#optional-set-up-quarto-website-of-analysis" id="toc-optional-set-up-quarto-website-of-analysis" class="nav-link" data-scroll-target="#optional-set-up-quarto-website-of-analysis">[Optional] Set up quarto website of analysis</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Setting up a reproducible multi-language data analysis environment</h1>
  <div class="quarto-categories">
    <div class="quarto-category">julia</div>
    <div class="quarto-category">coding setup</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Benjamin Doran </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 8, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>There are a lot of ways to set up and code in Julia, but here I’ll document the most convienent ways I’ve found.</p>
<p>I tend to use a Macbook Pro, so this setup example is based on that experience. That said, this tutorial should work for most systems, though windows users may need to adjust some of the initial install instructions. Once we get to the Julia specific portions, the instructions should be mostly platform agnostic.</p>
<p>It’s also worth pointing out <a href="https://modernjuliaworkflows.org/">Modern Julia Workflows</a> for another set of opinions on how to work with Julia code.</p>
</section>
<section id="surrounding-tools" class="level2">
<h2 class="anchored" data-anchor-id="surrounding-tools">Surrounding tools</h2>
<p>I use <a href="https://github.com/JuliaLang/juliaup"><code>juliaup</code></a> to manage my installed julia version, and edit code in the <a href="https://code.visualstudio.com/download"><code>vscode</code></a> editor with the <a href="https://code.visualstudio.com/docs/languages/julia"><code>julia extension</code></a> and <a href="https://quarto.org/docs/get-started/index.html"><code>quarto extension</code></a></p>
<p>If not installed previously</p>
<ul>
<li>xcode command line tools
<ul>
<li>run <code>xcode-select --install</code> in the terminal to install <code>git</code> and other command line tools</li>
</ul></li>
<li><a href="https://brew.sh/">Homebrew</a>: a package manager for Mac, helps to install other command line tools</li>
<li><a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">Github SSH key</a> for more easily interacting with github</li>
</ul>
<p>installing these three things will ease coding on mac, not just for Julia but also for Python and R.</p>
</section>
<section id="installing-julia" class="level2">
<h2 class="anchored" data-anchor-id="installing-julia">Installing Julia</h2>
<p><a href="https://github.com/JuliaLang/juliaup"><code>juliaup</code></a> is pretty easy to install from the command line on unix</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-fsSL</span> https://install.julialang.org <span class="kw">|</span> <span class="fu">sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Windows has simple install instructions at the link as well.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">winget</span> install julia <span class="at">-s</span> msstore</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The latest release version of julia is then installed with juliaup with</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">juliaup</span> add release</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is usually already added when installing juliaup, but it doesn’t hurt to check that the version exists with</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">juliaup</span> status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>install vscode <a href="https://code.visualstudio.com/download">here</a>, and in the extensions tab you can install the julia extension following <a href="https://code.visualstudio.com/docs/languages/julia">these instructions</a> and install quarto using <a href="https://quarto.org/docs/get-started/index.html">these instructions</a></p>
<p>These are the basic tools, from here I also install some julia specific tools to better manage my data analysis projects.</p>
</section>
<section id="julia-specific-setup" class="level2">
<h2 class="anchored" data-anchor-id="julia-specific-setup">Julia specific setup</h2>
<p>Julia’s default package manager is excellent. For package development it is basically complete, but for data analysis projects it can be made a bit better with the installation of two extra packages.</p>
<p>First is <a href="https://juliadynamics.github.io/DrWatson.jl/dev/">DrWatson.jl</a> which is a package specifically for data analysis projects. Like <a href="https://github.com/drivendata/cookiecutter-data-science">cookiecutter data science</a>, DrWatson provides a template for reproducible analysis projects. And, helps to manage the local and relative filepaths in your projects.</p>
<p>It can be installed from the julia package mode. start julia in the terminal by typing <code>julia</code> and hitting enter.</p>
<p>Then enter package mode by pressing <code>]</code></p>
<p>install by typing in</p>
<pre><code>add DrWatson</code></pre>
<p>exit package mode by pressing the backspace key.</p>
<p>The other package is useful if I am also using Python in my project, or have external commandline tools that are only available in the conda ecosystem. The package is <a href="https://docs.juliahub.com/General/CondaPkg/stable/">CondaPkg.jl</a>. And it allows installation of these python and conda tools in conjunction with the rest of my Julia code in completely reproducible way.</p>
<p>Install this package in the same way as DrWatson, by entering the julia package mode and typing in</p>
<pre><code>add CondaPkg</code></pre>
<p>to use condapkg, we need to first load it</p>
<p>exit package mode and type</p>
<pre><code>using CondaPkg</code></pre>
<p>then renter package mode and there is a new command <code>conda ...</code> that we can use that will add python and conda packages and store config files so that the analysis project knows exactly which versions have been loaded.</p>
<p>For those that this makes sense: It is a wrapper around micromamba and stores the conda environment in a toml file that is readable by Julia and can be reproduced.</p>
<pre><code># from CondaPkg docs
pkg&gt; conda status                # see what we have installed
pkg&gt; conda add python perl       # adds conda packages
pkg&gt; conda pip_add build         # adds pip packages
pkg&gt; conda rm perl               # removes conda packages
pkg&gt; conda run python --version  # runs the given command in the conda environment
pkg&gt; conda update                # update conda and pip installed packages</code></pre>
<p>To negate the need to manually type in <code>using CondaPkg</code> whenever we restart julia, we can add</p>
<pre><code>@async @eval using CondaPkg</code></pre>
<p>into <code>~/.julia/config/startup.jl</code> (the default location julia is installed on unix systems), and CondaPkg will be loaded every time Julia restarts.</p>
</section>
<section id="project-specific-setup" class="level2">
<h2 class="anchored" data-anchor-id="project-specific-setup">Project specific setup</h2>
<p>to use the project template provided by DrWatson, we first load it, then call the <code>initialize_project()</code> function.</p>
<pre><code>using DrWatson
# creates template project "test_proj" in folder `test_proj` as a sub-folder of the folder where we started julia
initialize_project("test_proj") </code></pre>
<p>generally I like to have one folder where I store all my coding and analysis projects. I locate this in my home directory.</p>
<p>from the command line I write <code>mkdir -p ~/projects</code> to create this folder.</p>
<p>Then I could either start julia from within that folder, and use the previous commands to create a project directory in that folder.</p>
<p>Or, if I started julia from somewhere else, I can tell julia to change the folder it’s started in by running <code>cd("~/projects")</code>. And then I can run <code>initialize_project("test_proj")</code> and get my template project created in the correct spot.</p>
<p>Lets open this folder in vscode.</p>
<p>Either start vscode first, hit <code>CMD+o</code> open the folder selector and select your template project.</p>
<p>Or with the vscode launcher, from the command line type <code>code ~/projects/test_proj</code>, which will start vscode with the project open.</p>
<p>To install the command line launcher, start vscode, hit <code>CMD+SHIFT+p</code>. In the search bar that pop up type <code>code</code>, and click on the <code>Shell Command: Install 'code' command in PATH</code></p>
<p>With the template project created we should see these directories</p>
<pre><code>test_proj % tree
.
├── Manifest.toml
├── Project.toml
├── README.md
├── _research
├── data
│   ├── exp_pro
│   ├── exp_raw
│   └── sims
├── notebooks
├── papers
├── plots
├── scripts
│   └── intro.jl
├── src
│   └── dummy_src_file.jl
└── test
    └── runtests.jl

12 directories, 6 files</code></pre>
<p>See <a href="https://juliadynamics.github.io/DrWatson.jl/dev/">DrWatson.jl</a> for more in depth descriptions. But basically, <code>Project.toml</code>, and <code>Manifest.toml</code> are computer generated configuration files so that as we add packages to our project, they will store which packages and versions we have installed. If we use CondaPkg to install a package a new configuration file <code>CondaPkg.toml</code> will be created that stores listings of those packages and versions.</p>
<p>As an example lets add CondaPkg to our project environment.</p>
<p>hit <code>CONTROL+`</code> this will open up the terminal within vscode, usually already located at your project folder.</p>
<p>type in <code>julia</code>, to start the julia REPL (read; evaluate; print; loop) in the terminal. enter package mode by hitting <code>]</code>.</p>
<p>you should see</p>
<pre><code>(@v1.10) pkg&gt; </code></pre>
<p>where in parentheses is the version number of julia you installed. As of January 2024 the latest release version is v1.10. This indicates that you are in the global julia environment. You could install and load packages from here but they would not be reproducible for others or yourself if they clone your project.</p>
<p>Instead, we will activate the project environment. the easiest what is by typing</p>
<pre><code>activate .</code></pre>
<p>where the <code>.</code> indicates the current working directory</p>
<p>alternatively type <code>activate ~/projects/test_proj</code> to activate the environment from anywhere</p>
<p>you should now see</p>
<pre><code>(test_proj) pkg&gt; </code></pre>
<p>If we now add CondaPkg or any other julia package they will be installed into the project environment.</p>
<p>type <code>add CondaPkg</code> into the prompt and hit enter.</p>
<p>After it is installed, if you open <code>Project.toml</code>, you should see</p>
<pre><code>[deps]
CondaPkg = "992eb4ea-22a4-4c89-a5bb-47a3300528ab"
DrWatson = "634d3b9d-ee7a-5ddf-bec9-22491ea816e1"</code></pre>
<p>as well as some other configurations.</p>
<p>This is a useful section to look at just to check if the packages you think are installed in your project are in fact installed in the project. The specifics of the versions installed are in the <code>Manifest.toml</code> file.</p>
<p>For the most part, you won’t need to look at these files, but they are how the project is made reproducible.</p>
<p>The <code>README.md</code> file in the template project has basic instructions for how the project can be cloned and instantiated on another computer.</p>
</section>
<section id="layout-of-project" class="level2">
<h2 class="anchored" data-anchor-id="layout-of-project">Layout of project</h2>
<section id="main-important-folders" class="level3">
<h3 class="anchored" data-anchor-id="main-important-folders">main important folders</h3>
<p>For how I like to work in my projects, the two most important folders are the <code>data/exp_raw</code> and <code>notebooks</code>.</p>
<p><code>data/exp_raw</code> is where data generally first enters the project. Downloaded datasets, or unprocessed data should go in here. Generally, I like to create a subfolder in here for each dataset, like <code>data/exp_raw/&lt;dataset_1&gt;</code> or usually something a bit more memorable. and then all files associated with that dataset, go in that folder.</p>
<p><code>notebooks</code> is ignored by git (version control software) by default in the template project. So usually the first thing I do is comment out this line in the <code>.gitignore</code> file</p>
<pre><code># /notebooks</code></pre>
<p>The reason is that notebooks have a tendency to get large. I usually don’t hit the 100mb per file limit on github though so I find it more useful to version control the notebooks.</p>
<p>In this folder I use juptyer notebooks to run analysis in Julia, Python, and R. As a naming scheme I usually do <code>&lt;incrementing number&gt;_&lt;language&gt;_&lt;description&gt;.ipynb</code>. for example <code>00_jl_setupdata.ipynb</code>.</p>
<p>I tend to prefer using these notebooks because the plots are stored inline with the file. So, if I need to remember some visual, that I didn’t think to save at the time, the plot still exists in the notebook. It also means that I don’t need to re-run potentially quite long computations, every time I need to go back and remember a plot.</p>
<p>The notebooks also integrate well with <a href="https://quarto.org/">Quarto</a> which enables generating static HTML pages of each notebook, without needing to rerun every notebook or script for every re-render.</p>
</section>
<section id="other-folders" class="level3">
<h3 class="anchored" data-anchor-id="other-folders">other folders</h3>
<p><code>plots</code> stores plots, I usually create a subfolder in here for each notebook.</p>
<p><code>scripts</code> similar to <code>notebooks</code> any set of code that is writing out files or plots, should probably be in here, I use this for scripts that I dispatch to the university SLURM cluster or AWS.</p>
<p><code>src</code> should only contain function declarations, i.e.&nbsp;code that I re-use across notebooks. If I am being fancy and developing custom analysis code that I will be using across projects, I will generate a full julia package and stick it in here as a git submodule. That is more advanced usage than we need to get into at the moment.</p>
<p><code>data/exp_pro</code> and <code>_research</code> are both folders I use as output directories. Usually again with a subfolder for each analysis, that might mean multiple sub-folders per notebook. Best practice is probably to use <code>_research</code> for more in progress outputs. And then once the output is stabilized, write it to <code>data/exp_pro</code>. I tend to use <code>data/exp_pro</code> for cleaned data that I will be using again in other notebooks, whereas <code>_research</code> I tend to put final results. i.e.&nbsp;the outputs of statistical tests, etc.</p>
<p><code>tests</code> This is meant for testing the functions written in <code>src</code>, to ensure correctness. I tend to create a full package in the <code>src</code> directory and use the <code>tests</code> folder in there. It could also be used to automate reproducing the project, but I have not fully explored that option.</p>
<p><code>papers</code> The intended purpose per DrWatson is for “Scientific papers resulting from the project.” I don’t use it much till the end.</p>
</section>
<section id="additional-folder-that-i-create" class="level3">
<h3 class="anchored" data-anchor-id="additional-folder-that-i-create">additional folder that I create</h3>
<p>I will sometimes create some additional folders</p>
<p><code>reference</code> for reference papers or other documents</p>
<p><code>docs</code> autogenerated output from quarto of my notebooks</p>
<p><code>wetlab_experiments</code> protocols and lab notes for experiments I am running related to the analysis project.</p>
<p>Generally I also add these folders to the .gitignore file because they are often more internal notes.</p>
<pre><code>/reference
/docs
/wetlab_experiments</code></pre>
</section>
</section>
<section id="starting-the-project" class="level2">
<h2 class="anchored" data-anchor-id="starting-the-project">Starting the project</h2>
<p>This will depend a lot on what kind of analysis I am doing, I usually add packages as I need them to the project environment.</p>
<p>Usually to start I have some raw, CSV file in <code>/data/exp_raw/initial_dataset</code>.</p>
<p>In the terminal I will start julia and enter the package mode for my project and install some package that I know I will need, this is usually some subset of these packages</p>
<pre><code>julia
]
pkg&gt; activate .
(test_proj) pkg&gt; add CSV, DataFramesMeta # packages for working with tabular data
(test_proj) pkg&gt; add StatsBase, LinearAlgebra # a bunch of standard statistics and basic linear algebra tooling
(test_proj) pkg&gt; add SpectralInference # My package working  for working with SVD decompositions of datasets
(test_proj) pkg&gt; add NewickTree # barebones package for working with newick style phylogenetic trees.
(test_proj) pkg&gt; add NeighborJoining # My package implementing basic neighborjoining in julia
(test_proj) pkg&gt; add Muon # julia interface for working with h5ad and h5mu file (useful files for storing matrix data with associated metadata)
(test_proj) pkg&gt; add HypothesisTests, MultipleTesting # standard statistical tests and multiple testing corrections
(test_proj) pkg&gt; add StatsPlots # lighter weight plotting package, concise syntax for plotting
(test_proj) pkg&gt; add CairoMakie # part of the https://docs.makie.org/stable/ ecosystem for plotting. in active development and starting to get more advanced than StatsPlots, can make prettier plots, needs a bit more code
(test_proj) pkg&gt; add LaTeXStrings # for adding latex captions and labels to plots
# I use these intermittently less, but are still worth the mention
(test_proj) pkg&gt; add UMAP # umap dimension reduction of large datasets
(test_proj) pkg&gt; add Symbolics # symbolic algebra in Julia
(test_proj) pkg&gt; add MLJ # analog of scikit-learn, enables access to a whole bunch of standard machine learning models
(test_proj) pkg&gt; add Flux # or Lux # basic deep learning toolkits in Julia
(test_proj) pkg&gt; add SciML # differential equation solving and simulation
(test_proj) pkg&gt; add Pluto # reactive notebooks, similar to jupyter notebooks but cells automatically re-compute, It's really useful for creating interactive dashboards for exploring datasets</code></pre>
<p>After installing the packages I want at the moment to start with</p>
<pre class="julia-pkg"><code>add CSV, DataFramesMeta, StatsBase, StatsPlots</code></pre>
<p>So, I will create a notebook</p>
<pre><code>00_jl_startcleaningdata.ipynb</code></pre>
<p>As the first cell of the notebook I will create a markdown cell and add some metadata</p>
<pre><code>---
title: Intial analysis cleaning data
author: Benjamin Doran
date: today
---</code></pre>
<p>This will be used by quarto later when rendering as a static document.</p>
<p>Below that I create a code cell with</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DrWatson</span> <span class="co"># load DrWatson from global environment</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@quickactivate</span> <span class="fu">projectdir</span>() <span class="co"># this activates the project environment so we can load the correct packages</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this way of activation works in the notebooks folder and most subfolders of the project.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for the activation to work anywhere on the computer explicitly write</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># @quickactivate "test_proj"</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># now we can load our packages from the package environment</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span>, <span class="bu">DataFrames</span>, <span class="bu">StatsPlots</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># I like this as a basic plotting theme</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="op">:</span>default, grid<span class="op">=</span><span class="cn">false</span>, tickdir<span class="op">=:</span>out, label<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># if we had individual files in `src` that we want to use</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># include(srcdir("helpers.jl")) </span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># usually this include line needs to be rerun if the file is adjusted, </span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># using Revise (https://timholy.github.io/Revise.jl/stable/), </span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># it might be possible to automatically reload the file on each save.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co"># any other package config code</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>ddir <span class="op">=</span> <span class="fu">datadir</span>(<span class="st">"exp_raw"</span>, <span class="st">"initial_dataset"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then I in the cells below I can write any analysis code I want, to read in, analyze, and plot the dataset.</p>
</section>
<section id="optional-set-up-quarto-website-of-analysis" class="level2">
<h2 class="anchored" data-anchor-id="optional-set-up-quarto-website-of-analysis">[Optional] Set up quarto website of analysis</h2>
<p>To render these notebooks as a html pages hosted as a static website.</p>
<p>I add a file <code>_quarto.yaml</code> into the <code>notebooks</code> folder, with these contents</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">project</span><span class="kw">:</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> website</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">output-dir</span><span class="kw">:</span><span class="at"> ../docs</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">website</span><span class="kw">:</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> &lt;title of project seen in browser tab&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">reader-mode</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sidebar</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">title</span><span class="kw">:</span><span class="at"> &lt;title of project seen in side bar of website&gt;,</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">style</span><span class="kw">:</span><span class="at"> </span><span class="st">"docked"</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">contents</span><span class="kw">:</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">href</span><span class="kw">:</span><span class="at"> index.qmd</span><span class="co"> # home page</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">text</span><span class="kw">:</span><span class="at"> Home</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 00_jl_startcleaningdata.ipynb</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">      # - other_analyses_i_have_done.ipynb</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span><span class="kw">:</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">html</span><span class="kw">:</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">theme</span><span class="kw">:</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">light</span><span class="kw">:</span><span class="at"> flatly</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">dark</span><span class="kw">:</span><span class="at"> darkly</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">css</span><span class="kw">:</span><span class="at"> styles.css</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">toc</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’ll also add a local .gitignore file to the <code>notebooks</code> folder with lines</p>
<pre><code>/.quarto/
cpuprof</code></pre>
<p>For the homepage, <code>notebooks/index.md</code> I’ll usually copy in the contents of <code>README.md</code> then edit from there. It should contain a paragraph describing the project at the least.</p>
<p>To locally preview the website open a terminal in the <code>notebooks</code> folder either in vscode or externally and enter the command</p>
<pre><code>quarto preview </code></pre>
<p>As you edit the notebooks, the website will automatically update with the changes.</p>
<p>When you’re project is finished, the website can be hosted on <a href="https://pages.github.com/">GitHub Pages</a></p>
<p>See this <a href="https://quarto.org/docs/publishing/github-pages.html">quarto tutorial</a> for setting that up.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/BenjaminDoran\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>